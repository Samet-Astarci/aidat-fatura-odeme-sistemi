<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daireler â€¢ Site Aidat Takip</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>
  <div class="container">
    <div id="nav"></div>
    <div class="grid">
      <div class="card">
        <div class="hd"><h2>Daire YÃ¶netimi ğŸ¢</h2></div>
        <div class="bd">
          
<div class="two-col">
  <div>
    <h3 style="margin-top:0;">Yeni Daire Ekle â•</h3>
    <div class="row">
      <div><label>Daire No</label><input id="number" type="number" /></div>
      <div><label>Durum</label>
        <select id="status">
          <option value="1">Dolu</option>
          <option value="0">BoÅŸ</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><label>Oturacak KullanÄ±cÄ± (opsiyonel)</label>
        <select id="userId"></select>
      </div>
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btnAdd">Kaydet</button>
    </div>
    <div class="footer-note">KayÄ±ttan sonra listeden kullanÄ±cÄ± atamasÄ± yapabilirsin ğŸ‘‡</div>
  </div>

  <div>
    <h3 style="margin-top:0;">Daireler ğŸ¢</h3>
    <table class="table" id="tbl">
      <thead><tr><th>No</th><th>Durum</th><th>Sakin</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

        </div>
      </div>
    </div>
  </div>
<script type="module">
import { requireAuth, api, qs } from "/assets/common.js";
import { mountNav, toast } from "/assets/ui.js";
requireAuth("admin");
mountNav();

async function loadUsers(){
  const data = await api("/api/users");
  const sel = qs("#userId");
  const options = [
    `<option value="">(SeÃ§me)</option>`,
    ...data.users.filter(u=>u.role==="resident").map(u=>`<option value="${u.id}">${u.name} (${u.phone})</option>`)
  ];
  sel.innerHTML = options.join("");
  return data.users;
}

async function refresh(){
  const a = await api("/api/apartments");
  const users = await api("/api/users");
  const tb = qs("#tbl tbody");
  tb.innerHTML = a.apartments.sort((x,y)=>x.number-y.number).map(ap=>{
    const badge = ap.status ? `<span class="badge ok">Dolu</span>` : `<span class="badge bad">BoÅŸ</span>`;
    return `
      <tr>
        <td><b>${ap.number}</b></td>
        <td>${badge}</td>
        <td>
          <select data-assign="${ap.id}">
            <option value="">(BoÅŸ)</option>
            ${users.users.filter(u=>u.role==="resident").map(u=>`
              <option value="${u.id}" ${ap.userId===u.id ? "selected":""}>${u.name}</option>
            `).join("")}
          </select>
        </td>
        <td><button class="btn-danger" data-del="${ap.id}">Sil</button></td>
      </tr>
    `;
  }).join("");

  tb.querySelectorAll("[data-assign]").forEach(sel=>{
    sel.addEventListener("change", async ()=>{
      const id = sel.getAttribute("data-assign");
      const userId = sel.value ? Number(sel.value) : null;
      try{
        await api("/api/apartments/"+id, { method:"PUT", body: JSON.stringify({ userId, status: userId ? 1 : 0 }) });
        toast("Atama gÃ¼ncellendi âœ…");
        refresh();
      }catch(e){
        toast("GÃ¼ncellenemedi âŒ", e.message);
      }
    });
  });

  tb.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-del");
      if (!confirm("Daire silinsin mi? (Ä°lgili borÃ§lar da silinir)")) return;
      try{
        await api("/api/apartments/"+id, { method:"DELETE" });
        toast("Silindi ğŸ—‘ï¸");
        refresh();
      }catch(e){ toast("Silinemedi âŒ", e.message); }
    });
  });
}

qs("#btnAdd").addEventListener("click", async ()=>{
  try{
    const userIdRaw = qs("#userId").value;
    const userId = userIdRaw ? Number(userIdRaw) : null;
    await api("/api/apartments", {
      method:"POST",
      body: JSON.stringify({
        number: Number(qs("#number").value),
        status: Number(qs("#status").value),
        userId
      })
    });
    toast("Daire eklendi âœ…");
    qs("#number").value="";
    refresh();
  }catch(e){
    toast("Eklenemedi âŒ", e.message);
  }
});

loadUsers().then(refresh);
</script>
</body>
</html>
